<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å¾ªåºæ¸è¿›è®¡åˆ’</title>
    <style>
        :root {
            --primary: #3b82f6; /* è“ï¼šæ¨ */
            --accent: #f97316; /* æ©™ï¼šæ‹‰ */
            --legs: #8b5cf6;    /* ç´«ï¼šè…¿ */
            --cardio: #eab308;  /* é»„ï¼šæœ‰æ°§ */
            --success: #10b981;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px 15px;
            min-height: 100vh;
        }

        .container { max-width: 500px; margin: 0 auto; }

        /* DASHBOARD */
        .dashboard {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }

        h1 { font-size: 1.2rem; margin: 0; color: var(--text-main); font-weight: 800; }
        .badge { 
            background: #eff6ff; color: var(--primary); padding: 4px 10px; border-radius: 20px; 
            font-size: 0.75rem; font-weight: 700;
        }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        }

        .stat-card {
            text-align: center; padding: 10px; background: #f8fafc; border-radius: 12px; border: 1px solid var(--border);
        }

        .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--text-main); display: block; }
        .stat-label { font-size: 0.7rem; color: var(--text-sub); }
        
        /* Progress Bar */
        .progress-container { margin-top: 15px; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 5px; color: var(--text-sub); }
        .progress-bar-bg { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; }
        .progress-bar-fill {
            height: 100%; background: var(--primary); width: 0%; 
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 5px; position: relative; overflow: hidden;
        }
        .progress-bar-fill::after {
            content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-100%); animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* CALENDAR */
        .cal-nav {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 10px;
        }
        .month-title { font-size: 1.1rem; font-weight: 700; }
        .nav-btn {
            background: white; border: 1px solid var(--border); width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-sub);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .calendar {
            background: var(--card-bg); border-radius: 20px; padding: 15px; box-shadow: var(--shadow);
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
        }

        .weekday { text-align: center; font-size: 0.7rem; color: #94a3b8; font-weight: 600; margin-bottom: 5px; }

        .day {
            aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600;
            position: relative; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; background: #f8fafc;
        }
        .day.today { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
        .day.disabled { opacity: 0.3; pointer-events: none; }
        .day:active { transform: scale(0.95); }
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 4px; transition: background 0.3s; }
        
        .day.done { background: #ecfdf5; color: var(--success); }
        .day.done .dot { background: var(--success) !important; }

        /* MODAL */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 99; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-mask.active { opacity: 1; pointer-events: all; }

        .modal {
            background: var(--card-bg); width: 90%; max-width: 400px;
            border-radius: 24px; padding: 25px;
            transform: translateY(30px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 85vh; overflow-y: auto;
        }
        .modal-mask.active .modal { transform: translateY(0); }

        .modal-header { margin-bottom: 20px; }
        .modal-date { font-size: 0.85rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .modal-title { font-size: 1.5rem; font-weight: 800; margin: 5px 0; color: var(--text-main); }
        
        .workout-list { list-style: none; padding: 0; margin: 0 0 25px 0; }
        
        .workout-item { border-bottom: 1px solid var(--border); padding: 12px 0; }
        
        .item-header { display: flex; align-items: center; cursor: pointer; }
        
        .checkbox {
            width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 6px;
            margin-right: 12px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: all 0.2s;
        }
        .checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .checkbox.checked::after { content: 'âœ“'; color: white; font-size: 14px; font-weight: bold; }

        .item-name { flex: 1; font-weight: 500; color: var(--text-main); }
        .info-icon { color: var(--primary); opacity: 0.6; font-size: 0.9rem; margin-left: 10px; }

        .item-desc {
            font-size: 0.85rem; color: var(--text-sub);
            background: #f8fafc; padding: 10px; border-radius: 8px; margin-top: 8px;
            display: none; line-height: 1.5;
        }
        .item-desc.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .action-btn {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-done { background: var(--text-main); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-done:active { transform: scale(0.98); }
        .btn-completed { background: var(--success); color: white; }

        .close-icon {
            position: absolute; top: 20px; right: 20px;
            background: #f1f5f9; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #64748b; font-weight: bold;
        }
        
        /* Tip Box */
        .beginner-tip {
            background: #fff7ed; border: 1px solid #ffedd5; color: #c2410c;
            padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="header-top">
            <div>
                <div class="badge">2025 å¢è‚Œåˆ·è„‚</div>
                <h1 style="margin-top:5px">åšæŒå°±æ˜¯èƒœåˆ©</h1>
            </div>
            <div style="text-align:right">
                <span style="font-size:2rem; display:block;">ğŸ’ª</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-val" id="daysLeft">--</span>
                <span class="stat-label">å‰©ä½™å¤©æ•°</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="streak">0</span>
                <span class="stat-label">è¿ç»­æ‰“å¡</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="workoutsDone">0</span>
                <span class="stat-label">å·²å®Œæˆ</span>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-info">
                <span>æ€»è¿›åº¦</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
        </div>
    </div>

    <div class="beginner-tip">
        <span style="font-size:1.2em">ğŸ’ª</span>
        <span><strong>åŠ æ²¹åŠ æ²¹ï¼</span>
    </div>

    <div class="cal-nav">
        <div class="nav-btn" onclick="changeMonth(-1)">â®</div>
        <div class="month-title" id="monthLabel">...</div>
        <div class="nav-btn" onclick="changeMonth(1)">â¯</div>
    </div>

    <div class="calendar" id="calendarGrid">
        <div class="weekday">æ—¥</div><div class="weekday">ä¸€</div><div class="weekday">äºŒ</div>
        <div class="weekday">ä¸‰</div><div class="weekday">å››</div><div class="weekday">äº”</div><div class="weekday">å…­</div>
        </div>
    
    <div style="text-align:center; margin-top:20px; font-size:0.75rem; color:#94a3b8;">
        <span style="color:var(--primary)">â—</span> èƒ¸è‚©æ¨ &nbsp; 
        <span style="color:var(--accent)">â—</span> èƒŒäºŒå¤´ &nbsp; 
        <span style="color:var(--legs)">â—</span> è…¿æ ¸å¿ƒ &nbsp; 
        <span style="color:var(--cardio)">â—</span> å…¨èº«æœ‰æ°§ &nbsp;
        <span style="color:#cbd5e1">â—</span> ä¼‘æ¯
    </div>
</div>

<div class="modal-mask" id="modalMask" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="close-icon" onclick="closeModal()">âœ•</div>
        
        <div class="modal-header">
            <div class="modal-date" id="mDate">...</div>
            <h2 class="modal-title" id="mTitle">...</h2>
            <p style="font-size:0.9rem; color:#64748b; margin:5px 0;" id="mSubtitle">...</p>
        </div>

        <ul class="workout-list" id="mList"></ul>

        <button class="action-btn btn-done" id="mBtn" onclick="toggleDayFinish()">å®Œæˆä»Šæ—¥æ‰“å¡</button>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    const DB_KEY = 'fitness_plan_2025_v7'; // æ›´æ–°ç‰ˆæœ¬å·
    const START_DATE_STR = "2025-11-21"; // ä»Šå¤©å¼€å§‹
    const END_DATE_STR = "2026-01-31";
    
    // --- è®­ç»ƒå†…å®¹åº“ (æ–°æ‰‹å‹å¥½ç‰ˆ) ---
    const WORKOUTS = {
        Day1: {
            type: 'Day1',
            title: "Day 1: æ¨ç±»è®­ç»ƒ",
            subtitle: "èƒ¸ / è‚© / ä¸‰å¤´",
            color: "var(--primary)",
            exercises: [
                { name: "èƒ¸æ¨æœº (Chest Press)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶4ç»„", desc: "è°ƒæ•´åº§æ¤…é«˜åº¦ï¼Œæ¡æŠŠä¸èƒ¸éƒ¨ä¸­çº¿é½å¹³ã€‚å‘åŠ›æ¨å‡ºï¼Œè¿˜åŸæ—¶æ§åˆ¶é€Ÿåº¦ã€‚" },
                { name: "ä¸Šæ–œå“‘é“ƒæ¨ä¸¾", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "æ¤…å­è°ƒè‡³30æˆ–45åº¦ã€‚ä¸Šä¸¾è‡³æ‰‹è‡‚ä¼¸ç›´ä½†ä¸è¦é”æ­»è‚˜å…³èŠ‚ã€‚" },
                { name: "è´è¶æœºå¤¹èƒ¸ (Pec Fly)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "ä¿æŒæ‰‹è‚˜å¾®å±ˆï¼ŒåƒæŠ±å¤§æ ‘ä¸€æ ·åˆæ‹¢ï¼Œæ„Ÿå—èƒ¸è‚Œå†…ä¾§æŒ¤å‹ã€‚" },
                { name: "åå§¿è‚©æ¨æœº", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "æ¨ä¸¾è¿‡å¤´é¡¶ã€‚æ ¸å¿ƒæ”¶ç´§ï¼ŒèƒŒéƒ¨è´´ç´§æ¤…èƒŒï¼Œä¸è¦è¿‡åº¦åå¼“è…°éƒ¨ã€‚" },
                { name: "å“‘é“ƒä¾§å¹³ä¸¾", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "åƒå€’æ°´ä¸€æ ·ä¸¾èµ·å“‘é“ƒï¼Œå¤§è‡‚å¸¦åŠ¨å°è‡‚ï¼Œä¸è¦è€¸è‚©ã€‚" },
                { name: "é¾™é—¨æ¶ç»³ç´¢ä¸‹å‹", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "å¤§è‡‚å¤¹ç´§èº«ä½“ä¸¤ä¾§ä¸åŠ¨ï¼ŒåªåŠ¨å°è‡‚å‘ä¸‹å‹ï¼Œç»ƒä¸‰å¤´è‚Œã€‚" }
            ]
        },
        Day2: {
            type: 'Day2',
            title: "Day 2: æ‹‰ç±»è®­ç»ƒ",
            subtitle: "èƒŒ / äºŒå¤´",
            color: "var(--accent)",
            exercises: [
                { name: "é«˜ä½ä¸‹æ‹‰ (Lat Pulldown)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶4ç»„", desc: "å®½æ¡ã€‚ä¸‹æ‹‰æ—¶æŒºèƒ¸ï¼Œæƒ³ç€æŠŠæ¨ªæ†æ‹‰å‘é”éª¨ï¼Œè‚˜éƒ¨å‘ä¸‹å‘åã€‚" },
                { name: "åå§¿åˆ’èˆ¹ (Seated Row)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "è„šè¹¬ç¨³ï¼ŒèƒŒæŒºç›´ã€‚æ‹‰æ‰‹æŸ„è‡³è…¹éƒ¨ï¼Œç”¨åŠ›å¤¹ç´§èƒŒéƒ¨è‚©èƒ›éª¨ã€‚" },
                { name: "å•è‡‚å“‘é“ƒåˆ’èˆ¹", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "ä¸€åªæ‰‹æ‰¶æ¤…å­ï¼Œå¦ä¸€åªæ‰‹ææ‹‰å“‘é“ƒã€‚å°½é‡æŠŠå“‘é“ƒæ‹‰å‘é«‹éƒ¨ä½ç½®ã€‚" },
                { name: "å“‘é“ƒå¼¯ä¸¾", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "ç«™å§¿æˆ–åå§¿ã€‚å¤§è‡‚å›ºå®šä¸åŠ¨ï¼Œå¼¯ä¸¾å“‘é“ƒæŒ¤å‹äºŒå¤´è‚Œã€‚" },
                { name: "äºŒå¤´å¼¯ä¸¾æœº", reps: "æ–°æ‰‹1ç»„ / è¿›é˜¶2ç»„", desc: "åˆ©ç”¨æœºå™¨å›ºå®šè½¨è¿¹ï¼Œæ¦¨å¹²äºŒå¤´è‚Œæœ€åçš„åŠ›é‡ã€‚" }
            ]
        },
        Day3: {
            type: 'Day3',
            title: "Day 3: è…¿ & æ ¸å¿ƒ",
            subtitle: "å…¨æœºå™¨ç‰ˆ (å®‰å…¨é«˜æ•ˆ)",
            color: "var(--legs)",
            exercises: [
                { name: "è…¿ä¸¾æœº (Leg Press)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶4ç»„", desc: "åŒè„šæ¯”è‚©å®½ã€‚ä¸‹æ”¾å°½é‡æ·±ï¼Œè¹¬èµ·æ—¶è†ç›–ä¸è¦å®Œå…¨é”æ­»ï¼ˆä¿ç•™å¾®å±ˆï¼‰ã€‚" },
                { name: "åå§¿è…¿ä¼¸å±• (Leg Ext)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "è¸¢è…¿æœºã€‚ç»ƒå¤§è…¿å‰ä¾§ï¼Œåˆ°é¡¶ç«¯åœé¡¿1ç§’æ•ˆæœæ›´å¥½ã€‚" },
                { name: "ä¿¯å§/åå§¿è…¿å¼¯ä¸¾", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "å‹¾è…¿æœºã€‚ç»ƒå¤§è…¿åä¾§ã€‚åŠ¨ä½œè¦æ…¢ï¼Œä¸è¦åˆ©ç”¨æƒ¯æ€§ç”©ã€‚" },
                { name: "è‡€æ¨æœº (Hip Thrust)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "å¦‚æœæ²¡æœ‰æœºå™¨ï¼Œå¯ä»¥ç”¨å“‘é“ƒæ”¾åœ¨é«‹éƒ¨åšè‡€æ¡¥ã€‚é¡¶é«‹å‘åŠ›æ”¶ç´§è‡€éƒ¨ã€‚" },
                { name: "å°è…¿æè¸µæœº", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "ç»ƒå°è…¿ã€‚å¯ä»¥ç”¨è…¿ä¸¾æœºåšï¼Œä¹Ÿå¯ä»¥ç”¨ç«™å§¿æè¸µæœºã€‚" },
                { name: "è…¹è‚Œæœº (Ab Machine)", reps: "æ–°æ‰‹2ç»„ / è¿›é˜¶3ç»„", desc: "å¦‚æœæ²¡æœ‰æœºå™¨ï¼Œåšå·è…¹æˆ–æ‚¬å‚ä¸¾è…¿ä»£æ›¿ã€‚" }
            ]
        },
        Day4: {
            type: 'Day4',
            title: "Day 4: è½»å…¨èº« + æœ‰æ°§",
            subtitle: "ç»¼åˆæ¶ˆè€— & å¿ƒè‚º",
            color: "var(--cardio)",
            exercises: [
                { name: "æœºå™¨èƒ¸æ¨ (è½»é‡é‡)", reps: "2ç»„ x 12æ¬¡", desc: "ä¿æŒè‚Œè‚‰æ´»æ€§ï¼Œé‡é‡ä¸éœ€è¦å¤ªå¤§ã€‚" },
                { name: "åå§¿åˆ’èˆ¹ (è½»é‡é‡)", reps: "2ç»„ x 12æ¬¡", desc: "æ³¨é‡æ”¶ç¼©æ„Ÿï¼ŒåŠ¨ä½œæ ‡å‡†ä¸ºä¸»ã€‚" },
                { name: "è…¿ä¸¾æœº (è½»é‡é‡)", reps: "2ç»„ x 12æ¬¡", desc: "ä¿ƒè¿›è…¿éƒ¨è¡€æ¶²å¾ªç¯ã€‚" },
                { name: "å“‘é“ƒè‚©æ¨ (è½»é‡é‡)", reps: "2ç»„ x 12æ¬¡", desc: "ä¿æŒè‚©å…³èŠ‚æ´»åŠ¨åº¦ã€‚" },
                { name: "è·‘æ­¥æœºçˆ¬å¡", reps: "20-25åˆ†é’Ÿ", desc: "å¡åº¦è®¾ç½®3-5ï¼Œé€Ÿåº¦é€‚ä¸­ï¼ˆå¿«èµ°çŠ¶æ€ï¼‰ï¼Œä¿æŒå¿ƒç‡å¹³ç¨³ã€‚" }
            ]
        },
        Rest: {
            type: 'Rest',
            title: "ä¼‘æ¯æ—¥",
            subtitle: "æ¢å¤ / è¥å…»",
            color: "#cbd5e1",
            exercises: [
                { name: "å½»åº•æ”¾æ¾", reps: "å…¨å¤©", desc: "ä»Šå¤©æ— éœ€å»å¥èº«æˆ¿ï¼Œç»™å…³èŠ‚å’Œç¥ç»æ”¾ä¸ªå‡ã€‚" },
                { name: "ä¼˜è´¨ç¡çœ ", reps: "8å°æ—¶", desc: "è‚Œè‚‰åœ¨ç¡çœ ä¸­ä¿®å¤ç”Ÿé•¿ã€‚" }
            ]
        }
    };

    // å¾ªç¯æ¨¡å¼ï¼šDay1(æ¨) â†’ Day2(æ‹‰) â†’ ä¼‘æ¯ â†’ Day3(è…¿) â†’ ä¼‘æ¯ â†’ Day4(å…¨èº«) â†’ ä¼‘æ¯
    const CYCLE = ['Day1', 'Day2', 'Rest', 'Day3', 'Rest', 'Day4', 'Rest'];

    // --- é€»è¾‘ä¸åŠŸèƒ½ ---
    let viewDate = new Date();
    let selectedDateStr = null;
    let userData = JSON.parse(localStorage.getItem(DB_KEY)) || {};

    function getLocalDateStr(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    const START_DATE = new Date(START_DATE_STR);
    const END_DATE = new Date(END_DATE_STR);

    function getWorkoutType(dateStr) {
        const d = new Date(dateStr);
        const start = new Date(START_DATE_STR);
        const diffTime = d - start;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays < 0) return null;
        // ä½¿ç”¨ 7 å¤©å¾ªç¯
        return CYCLE[diffDays % 7];
    }

    function saveData() {
        localStorage.setItem(DB_KEY, JSON.stringify(userData));
        renderDashboard();
        renderCalendar();
    }

    function renderDashboard() {
        const today = new Date();
        const todayStr = getLocalDateStr(today);
        
        // 1. Days Left
        const end = new Date(END_DATE_STR);
        const diffTime = Math.max(0, end - today);
        const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        document.getElementById('daysLeft').innerText = daysLeft;

        // 2. Progress & Streak
        let totalPlanDays = 0;
        let doneCount = 0;
        let tempStreak = 0;
        
        let d = new Date(START_DATE_STR);
        const endDateObj = new Date(END_DATE_STR);
        
        while (d <= endDateObj) {
            const dStr = getLocalDateStr(d);
            totalPlanDays++;
            
            if (userData[dStr] && userData[dStr].done) {
                doneCount++;
            }
            
            if (d <= today) {
                if (userData[dStr] && userData[dStr].done) {
                    tempStreak++;
                } else if (dStr !== todayStr) {
                    tempStreak = 0;
                }
            }
            d.setDate(d.getDate() + 1);
        }

        document.getElementById('workoutsDone').innerText = doneCount;
        document.getElementById('streak').innerText = tempStreak;
        
        const pct = totalPlanDays === 0 ? 0 : Math.round((doneCount / totalPlanDays) * 100);
        document.getElementById('progressText').innerText = pct + "%";
        document.getElementById('progressBar').style.width = pct + "%";
    }

    function renderCalendar() {
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        document.getElementById('monthLabel').innerText = `${year}å¹´ ${month + 1}æœˆ`;

        const grid = document.getElementById('calendarGrid');
        while (grid.children.length > 7) grid.removeChild(grid.lastChild);

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay(); 
        const daysInMonth = lastDay.getDate();
        const todayStr = getLocalDateStr(new Date());

        for(let i=0; i<startDay; i++) { grid.appendChild(document.createElement('div')); }

        for(let d=1; d<=daysInMonth; d++) {
            const current = new Date(year, month, d);
            const dateStr = getLocalDateStr(current);
            const el = document.createElement('div');
            el.className = 'day';
            el.innerHTML = `<div>${d}</div>`;
            
            const startObj = new Date(START_DATE_STR);
            const endObj = new Date(END_DATE_STR);

            if (current < startObj || current > endObj) {
                el.classList.add('disabled');
            } else {
                const type = getWorkoutType(dateStr);
                const isDone = userData[dateStr]?.done;
                
                if (isDone) el.classList.add('done');
                if (type) {
                    const color = WORKOUTS[type].color;
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    if (!isDone) dot.style.backgroundColor = color;
                    el.appendChild(dot);
                }
                if (dateStr === todayStr) el.classList.add('today');
                el.onclick = () => openModal(dateStr, type);
            }
            grid.appendChild(el);
        }
    }

    function changeMonth(offset) {
        viewDate.setMonth(viewDate.getMonth() + offset);
        renderCalendar();
    }

    function openModal(dateStr, type) {
        if (!type) return;
        selectedDateStr = dateStr;
        const data = WORKOUTS[type];
        const record = userData[dateStr] || { items: [], done: false };

        document.getElementById('mDate').innerText = dateStr;
        document.getElementById('mTitle').innerText = data.title;
        document.getElementById('mTitle').style.color = data.color;
        document.getElementById('mSubtitle').innerText = data.subtitle;

        const list = document.getElementById('mList');
        list.innerHTML = '';
        
        data.exercises.forEach((ex, idx) => {
            const isChecked = record.items[idx] ? 'checked' : '';
            const li = document.createElement('li');
            li.className = 'workout-item';
            li.innerHTML = `
                <div class="item-header" onclick="toggleDesc(this)">
                    <div class="checkbox ${isChecked}" onclick="checkItem(event, ${idx}, this)"></div>
                    <div class="item-name">${ex.name} <br><span style="font-size:0.75em;color:#94a3b8;font-weight:normal">${ex.reps}</span></div>
                    <div class="info-icon">â“˜</div>
                </div>
                <div class="item-desc">${ex.desc}</div>
            `;
            list.appendChild(li);
        });

        updateBtnState(record.done);
        document.getElementById('modalMask').classList.add('active');
    }

    function closeModal(e) {
        document.getElementById('modalMask').classList.remove('active');
    }

    function toggleDesc(headerDom) {
        const desc = headerDom.nextElementSibling;
        desc.classList.toggle('show');
    }

// å‹¾é€‰å•é¡¹ï¼ˆä¿®æ”¹ç‰ˆï¼šæ”¯æŒè‡ªåŠ¨åˆ¤å®šå®Œæˆï¼‰
    function checkItem(e, idx, checkboxDom) {
        e.stopPropagation(); 
        checkboxDom.classList.toggle('checked');
        
        // 1. ç¡®ä¿æ•°æ®å¯¹è±¡å­˜åœ¨
        if (!userData[selectedDateStr]) userData[selectedDateStr] = { items: [], done: false };
        
        // 2. æ›´æ–°å½“å‰å‹¾é€‰çŠ¶æ€
        userData[selectedDateStr].items[idx] = checkboxDom.classList.contains('checked');
        
        // --- æ–°å¢ä»£ç  START ---
        // 3. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŠ¨ä½œéƒ½å·²å‹¾é€‰
        const type = getWorkoutType(selectedDateStr);
        if (type && WORKOUTS[type]) {
            const totalExercises = WORKOUTS[type].exercises.length;
            let allChecked = true;
            
            for (let i = 0; i < totalExercises; i++) {
                // åªè¦æœ‰ä¸€ä¸ªæ²¡å‹¾ï¼Œå°±ä¸æ˜¯å…¨éƒ¨å®Œæˆ
                if (!userData[selectedDateStr].items[i]) {
                    allChecked = false;
                    break;
                }
            }

            // å¦‚æœå…¨éƒ¨å‹¾é€‰äº†ï¼Œå¹¶ä¸”å½“å‰çŠ¶æ€è¿˜æ²¡æ˜¾ç¤ºâ€œå®Œæˆâ€ï¼Œåˆ™è‡ªåŠ¨è§¦å‘å®Œæˆ
            if (allChecked && !userData[selectedDateStr].done) {
                toggleDayFinish(); // è¿™ä¼šè‡ªåŠ¨æŠŠæŒ‰é’®å˜ç»¿ï¼Œå¹¶åœ¨0.4ç§’åå…³é—­å¼¹çª—
            }
        }
        // --- æ–°å¢ä»£ç  END ---

        saveData();
    }

    function toggleDayFinish() {
        if (!userData[selectedDateStr]) userData[selectedDateStr] = { items: [], done: false };
        const newState = !userData[selectedDateStr].done;
        userData[selectedDateStr].done = newState;
        updateBtnState(newState);
        saveData(); 
        if (newState) setTimeout(() => closeModal(), 400);
    }

    function updateBtnState(isDone) {
        const btn = document.getElementById('mBtn');
        if (isDone) {
            btn.innerText = "å·²å®Œæˆ (ç‚¹å‡»æ’¤é”€)";
            btn.className = "action-btn btn-completed";
        } else {
            btn.innerText = "å®Œæˆä»Šæ—¥æ‰“å¡";
            btn.className = "action-btn btn-done";
        }
    }

    // Init
    renderDashboard();
    renderCalendar();

</script>
</body>
</html>